gws_refer_id, exposure_or_outcome_name, exposure_or_outcome_data_id,
chromo = '', position = '', eff_allele = '', non_eff_allele = '', beta_val = '', p_val = '',
columns_to_remove = c()) {
formatted_file_name <- paste0(exposure_or_outcome_name, "_", exposure_or_outcome_data_id, "_formatted.csv.gz")
if (file.exists(formatted_file_name)) {                                       # æ ¼å¼åŒ–åçš„æ–‡ä»¶å­˜åœ¨åˆ™è·³è¿‡å¤„ç†
return(paste0("æ–‡ä»¶å·²å­˜åœ¨ï¼ˆ", formatted_file_name, "ï¼‰ã€‚è·³è¿‡æ ¼å¼åŒ–â€¦â€¦"))
} else { cat("å¼€å§‹è¯»å–æ•°æ®â€¦â€¦\n") }
if_rename <- FALSE
if (f_fmt == "tsv") { data <- read.delim(file,sep ="\t"); if_rename <- TRUE }       # é¢„è¯»å– TSV æ–‡ä»¶ï¼Œå¹¶è®¡åˆ’é‡å‘½ååˆ—
else if (f_fmt == "csv") { data <- readr::read_csv(file); if_rename <- TRUE }  # é¢„è¯»å– CSV æ–‡ä»¶ï¼Œå¹¶è®¡åˆ’é‡å‘½ååˆ—
else if (f_fmt == "vcf") { data <- file }                                      # VCF æ–‡ä»¶ä¸éœ€è¦é¢„è¯»å–
else { stop(paste0("å°šæœªæ”¯æŒ ", f_fmt, " æ ¼å¼ã€‚æ•°æ®æ ¼å¼åŒ–å¼‚å¸¸é€€å‡ºï¼")) }
if (if_rename) {                                                               # åˆ é™¤ç‰¹å®šåˆ—å¹¶é‡å‘½ååˆ—
data <- data %>%
select(-one_of(columns_to_remove)) %>%  # åˆ é™¤æŒ‡å®šåˆ—
select_if(~!all(is.na(.))) %>%          # åˆ é™¤æ‰€æœ‰å€¼å‡ä¸º NA çš„åˆ—
dplyr::rename(
CHR = chromo,         # SNP æ‰€åœ¨æŸ“è‰²ä½“å·
BP = position,        # SNP æ‰€åœ¨æŸ“è‰²ä½“ä½ç½®
A1 = eff_allele,      # æ•ˆåº”ç­‰ä½åŸºå› 
A2 = non_eff_allele,  # éæ•ˆåº”ç­‰ä½åŸºå› 
BETA = beta_val,      # beta å€¼
P = p_val             # P å€¼
)  # ä»¥ä¸Š 6 åˆ—å¿…é¡»ä¸¥æ ¼å£°æ˜
cat("é¢„è¯»å–å·²å®Œæˆï¼Œå¼€å§‹æ ¼å¼åŒ–â€¦â€¦\n")
}
# åˆ é™¤æ—¥å¿—æ–‡ä»¶ï¼ˆæ–‡ä»¶åä¸­åŒ…å«â€œ_log_â€ï¼‰
for (file in list.files(getwd())) { if (grepl(paste0(exposure_or_outcome_name, "_", exposure_or_outcome_data_id, "_formatted_log_.+\\.txt"), file)) { file.remove(file) } }
MungeSumstats::format_sumstats(  # æ‰§è¡Œæ ¼å¼åŒ–
data,
ref_genome = gws_refer_id,                            # ç”¨äºGWASçš„å‚è€ƒåŸºå› ç»„æ ‡è¯†ç¬¦
dbSNP = 155,                                          # dbSNP ç‰ˆæœ¬å·ï¼ˆ144 æˆ– 155ï¼‰
ignore_multi_trait = TRUE,                            # å¿½ç•¥å¤šä¸ª P å€¼
strand_ambig_filter = FALSE,                          # åˆ é™¤å…·æœ‰ä¸²ä¸æ˜ç¡®åŸºå› çš„ SNP
bi_allelic_filter = FALSE,                            # å»é™¤éåŒç­‰ä½åŸºå› çš„ SNP
allele_flip_check = FALSE,                            # å¯¹ç…§å‚è€ƒåŸºå› ç»„æ£€æŸ¥å¹¶ç¿»è½¬ç­‰ä½åŸºå› æ–¹å‘
indels = FALSE,                                       # æ˜¯å¦åŒ…å« indel å˜å¼‚
nThread = 16,                                         # å¹¶è¡Œçš„çº¿ç¨‹æ•°
save_path = file.path(FMT_DIR, formatted_file_name),  # è¾“å‡ºæ ¼å¼åŒ–äº†çš„æ–‡ä»¶
log_mungesumstats_msgs = TRUE,                        # ä¿å­˜æ—¥å¿—ä¿¡æ¯
log_folder = getwd(),                                 # æ—¥å¿—æ–‡ä»¶å¤¹ä¿å­˜è·¯å¾„
)
cat(paste0("æ ¼å¼åŒ–å·²å®Œæˆï¼š", formatted_file_name, "\n"))
}
# ---æ ¼å¼åŒ–æš´éœ²æ•°æ®
format_gwas_data(file = exposure_file, f_fmt = "tsv",
gws_refer_id = EXPOSURE_REFER_ID, exposure_or_outcome_name = EXPOSURE_NAME, exposure_or_outcome_data_id = EXPOSURE_DATA_ID,
# chromo = "...", position = "...", eff_allele = "...", non_eff_allele = "...", beta_val = "...", p_val = "..."
)
gws_refer_id, exposure_or_outcome_name, exposure_or_outcome_data_id,
file = exposure_file, f_fmt = "tsv",
file = exposure_file
f_fmt = "tsv"
gws_refer_id = EXPOSURE_REFER_ID
exposure_or_outcome_name = EXPOSURE_NAME
exposure_or_outcome_data_id = EXPOSURE_DATA_ID
formatted_file_name <- paste0(exposure_or_outcome_name, "_", exposure_or_outcome_data_id, "_formatted.csv.gz")
if (file.exists(formatted_file_name)) {                                       # æ ¼å¼åŒ–åçš„æ–‡ä»¶å­˜åœ¨åˆ™è·³è¿‡å¤„ç†
return(paste0("æ–‡ä»¶å·²å­˜åœ¨ï¼ˆ", formatted_file_name, "ï¼‰ã€‚è·³è¿‡æ ¼å¼åŒ–â€¦â€¦"))
} else { cat("å¼€å§‹è¯»å–æ•°æ®â€¦â€¦\n") }
if_rename <- FALSE
if (f_fmt == "tsv") { data <- read.delim(file,sep ="\t"); if_rename <- TRUE }       # é¢„è¯»å– TSV æ–‡ä»¶ï¼Œå¹¶è®¡åˆ’é‡å‘½ååˆ—
if (if_rename) {                                                               # åˆ é™¤ç‰¹å®šåˆ—å¹¶é‡å‘½ååˆ—
data <- data %>%
select(-one_of(columns_to_remove)) %>%  # åˆ é™¤æŒ‡å®šåˆ—
select_if(~!all(is.na(.))) %>%          # åˆ é™¤æ‰€æœ‰å€¼å‡ä¸º NA çš„åˆ—
dplyr::rename(
CHR = chromo,         # SNP æ‰€åœ¨æŸ“è‰²ä½“å·
BP = position,        # SNP æ‰€åœ¨æŸ“è‰²ä½“ä½ç½®
A1 = eff_allele,      # æ•ˆåº”ç­‰ä½åŸºå› 
A2 = non_eff_allele,  # éæ•ˆåº”ç­‰ä½åŸºå› 
BETA = beta_val,      # beta å€¼
P = p_val             # P å€¼
)  # ä»¥ä¸Š 6 åˆ—å¿…é¡»ä¸¥æ ¼å£°æ˜
cat("é¢„è¯»å–å·²å®Œæˆï¼Œå¼€å§‹æ ¼å¼åŒ–â€¦â€¦\n")
}
columns_to_remove
columns_to_remove = c()
if (if_rename) {                                                               # åˆ é™¤ç‰¹å®šåˆ—å¹¶é‡å‘½ååˆ—
data <- data %>%
select(-one_of(columns_to_remove)) %>%  # åˆ é™¤æŒ‡å®šåˆ—
select_if(~!all(is.na(.))) %>%          # åˆ é™¤æ‰€æœ‰å€¼å‡ä¸º NA çš„åˆ—
dplyr::rename(
CHR = chromo,         # SNP æ‰€åœ¨æŸ“è‰²ä½“å·
BP = position,        # SNP æ‰€åœ¨æŸ“è‰²ä½“ä½ç½®
A1 = eff_allele,      # æ•ˆåº”ç­‰ä½åŸºå› 
A2 = non_eff_allele,  # éæ•ˆåº”ç­‰ä½åŸºå› 
BETA = beta_val,      # beta å€¼
P = p_val             # P å€¼
)  # ä»¥ä¸Š 6 åˆ—å¿…é¡»ä¸¥æ ¼å£°æ˜
cat("é¢„è¯»å–å·²å®Œæˆï¼Œå¼€å§‹æ ¼å¼åŒ–â€¦â€¦\n")
}
head(data)
colnames(data)
# ---æ ¼å¼åŒ–æš´éœ²æ•°æ®
format_gwas_data(file = exposure_file, f_fmt = "tsv",
gws_refer_id = EXPOSURE_REFER_ID, exposure_or_outcome_name = EXPOSURE_NAME, exposure_or_outcome_data_id = EXPOSURE_DATA_ID,
chromo = "chromosome", position = "hm_pos", eff_allele = "hm_effect_allele", non_eff_allele = "hm_other_allele", beta_val = "hm_beta", p_val = "p_value"
)
# ---æ ¼å¼åŒ–æš´éœ²æ•°æ®
format_gwas_data(file = exposure_file, f_fmt = "tsv",
gws_refer_id = EXPOSURE_REFER_ID, exposure_or_outcome_name = EXPOSURE_NAME, exposure_or_outcome_data_id = EXPOSURE_DATA_ID,
chromo = "chromosome", position = "hm_pos", eff_allele = "hm_effect_allele", non_eff_allele = "hm_other_allele", beta_val = "hm_beta", p_val = "p_value"
)
outcome_file
# ---æ ¼å¼åŒ–ç»“å±€æ•°æ®
format_gwas_data(file = outcome_file, f_fmt = "tsv",
gws_refer_id = OUTCOME_REFER_ID, exposure_or_outcome_name = OUTCOME_NAME, exposure_or_outcome_data_id = OUTCOME_DATA_ID,
chromo = "chromosome", position = "base_pair_location", eff_allele = "effect_allele", non_eff_allele = "other_allele", beta_val = "beta_fe", p_val = "p_value"
)
gc()
gc()
data_exposure <- data
file
outcome_file
file = outcome_file
gws_refer_id = OUTCOME_REFER_ID
exposure_or_outcome_name
gws_refer_id
exposure_or_outcome_name = OUTCOME_NAME
exposure_or_outcome_name
exposure_or_outcome_data_id = OUTCOME_DATA_ID
exposure_or_outcome_data_id
OUTCOME_DATA_ID
EXPOSURE_DATA_ID
file
outcome_file
data_outcome <- read.delim(file,spe = "\t")
data_outcome <- read.delim(file,sep = "\t")
gc()
rm(data)
rm(data_exposure)
rm(data_outcome)
install_if_not_installed <- function(pkg, install_function = install.packages) {
# æ£€æŸ¥åŒ…æ˜¯å¦å®‰è£…ï¼Œæˆ–æŒ‡å®šå®‰è£…å‡½æ•°
if (!requireNamespace(pkg, quietly = TRUE)) {
if (identical(install_function, install.packages)) {
install.packages(pkg)
} else {
install_function
}
}
}
pkgs <- c(  # éœ€è¦å®‰è£…çš„åŒ…åˆ—è¡¨
"VariantAnnotation", "gwasglue", "dplyr", "tidyr",
"CMplot", "TwoSampleMR", "MendelianRandomization",
"LDlinkR", "ggplot2", "ggforestplot", "ggfunnel",
"cowplot", "friendly2MR", "plinkbinr", "FastDownloader",
"FastTraitR", "MRPRESSO", "SNPlocs.Hsapiens.dbSNP155.GRCh37",
"SNPlocs.Hsapiens.dbSNP155.GRCh38","BSgenome.Hsapiens.NCBI.GRCh38", "tidyverse",
'MungeSumstats', 'GenomicFiles'
)
install_if_not_installed <- function(pkg, install_function = install.packages) {
# æ£€æŸ¥åŒ…æ˜¯å¦å®‰è£…ï¼Œæˆ–æŒ‡å®šå®‰è£…å‡½æ•°
if (!requireNamespace(pkg, quietly = TRUE)) {
if (identical(install_function, install.packages)) {
install.packages(pkg)
} else {
install_function
}
}
}
pkgs <- c(  # éœ€è¦å®‰è£…çš„åŒ…åˆ—è¡¨
"VariantAnnotation", "gwasglue", "dplyr", "tidyr",
"CMplot", "TwoSampleMR", "MendelianRandomization",
"LDlinkR", "ggplot2", "ggforestplot", "ggfunnel",
"cowplot", "friendly2MR", "plinkbinr", "FastDownloader",
"FastTraitR", "MRPRESSO", "SNPlocs.Hsapiens.dbSNP155.GRCh37",
"SNPlocs.Hsapiens.dbSNP155.GRCh38","BSgenome.Hsapiens.NCBI.GRCh38", "tidyverse",
'MungeSumstats', 'GenomicFiles'
)
# æœªå®‰è£…åˆ™å®‰è£…
install_if_not_installed("devtools")
install_if_not_installed("tidyverse")
install_if_not_installed("gwasglue", devtools::install_github("mrcieu/gwasglue", force = TRUE))
install_if_not_installed("BiocManager")
install_if_not_installed("VariantAnnotation", BiocManager::install)
install_if_not_installed("dplyr")
install_if_not_installed("tidyr")
install_if_not_installed("CMplot")
install_if_not_installed("remotes")
install_if_not_installed("TwoSampleMR", remotes::install_github("MRCIEU/TwoSampleMR"))
install_if_not_installed("MendelianRandomization")
install_if_not_installed("LDlinkR")
install_if_not_installed("ggfunnel", devtools::install_github("pedropark99/ggfunnel", force = TRUE))
install_if_not_installed("ggforestplot", devtools::install_github("NightingaleHealth/ggforestplot", force = TRUE))
install_if_not_installed("friendly2MR", devtools::install_github("xiechengyong123/friendly2MR", force = TRUE))
# install_friendly2MR_dependence()
install_if_not_installed("plinkbinr", devtools::install_github("explodecomputer/plinkbinr", force = TRUE))
# https://flash0926.yuque.com/org-wiki-flash0926-kivyu0/otdnsb/tluzaguvye4t9l08
install_if_not_installed("FastDownloader")
install_if_not_installed("FastTraitR", FastDownloader::install_pkg("FastTraitR"))
install_if_not_installed("MRPRESSO")
install_if_not_installed("SNPlocs.Hsapiens.dbSNP155.GRCh37", BiocManager::install("SNPlocs.Hsapiens.dbSNP155.GRCh37"))
install_if_not_installed("SNPlocs.Hsapiens.dbSNP155.GRCh38", BiocManager::install("SNPlocs.Hsapiens.dbSNP155.GRCh38"))
install_if_not_installed("BSgenome.Hsapiens.NCBI.GRCh38", BiocManager::install("BSgenome.Hsapiens.NCBI.GRCh38"))
install_if_not_installed("MungeSumstats", BiocManager::install("MungeSumstats"))
install_if_not_installed("GenomicFiles", BiocManager::install("GenomicFiles"))
# å¯¼å…¥åŒ…
lapply(pkgs, function(pkg) {
suppressMessages(library(pkg, character.only = TRUE, quietly = TRUE))
})
#rm(list = ls())  # åŒ…åˆå§‹åŒ–ç»“æŸ
# æŠ½å–æ•°æ®é›†å­é›†
extract_subset <- function(file_path, b = 1, N, subset_file) {
head_lines <- readr::read_lines(file_path, skip = 0, n_max = b)
remaining_lines <- readr::read_lines(file_path, skip = b + 1)
sample_lines <- sample(remaining_lines, N)
write_lines(c(head_lines, sample_lines), subset_file)
}
# ---GWAS æ•°æ®æš´éœ²å› ç´ å’Œç»“å±€ç®€ç§°ã€æ ‡è¯†ç¬¦ã€å‚è€ƒåŸºå› ç»„æ ‡è¯†ç¬¦ã€äººç¾¤ç±»åˆ«
EXPOSURE_NAME <- 'HbA1c'     # æ•°æ®åç§°ã€‚å»ºè®®ä½¿ç”¨è‹±æ–‡ç®€ç§°ï¼Œå¦‚ WBCã€BMI ç­‰
EXPOSURE_DATA_ID <- 'UKB_HbA1c'  # æ•°æ®æ ‡è¯†ç¬¦ã€‚å»ºè®®ä½¿ç”¨è‹±æ–‡ç®€ç§°ï¼Œå¦‚ UK_Biobank_BMI ç­‰
EXPOSURE_REFER_ID <- 'GRCh38' # GWAS æ•°æ®æ‰€ç”¨çš„å‚è€ƒåºåˆ—ç‰ˆæœ¬ï¼Œå¦‚ GRCh37 ç­‰
EXPOSURE_POP <- 'EUR'      # äººå£å­¦ç§ç¾¤æ ‡è¯†ï¼Œå¦‚ AFRï¼ˆéæ´²ï¼‰ã€AMRï¼ˆç¾æ´²ï¼‰ã€EASï¼ˆä¸œäºšï¼‰ã€EURï¼ˆæ¬§æ´²ï¼‰ã€SASï¼ˆå—äºšï¼‰
OUTCOME_NAME <- 'PD'
OUTCOME_DATA_ID <- '2024_Multi'
OUTCOME_REFER_ID <- 'GRCh38'
OUTCOME_POP <- 'EUR'
# åƒäººåŸºå› ç»„è®¡åˆ’ä¸­ç”¨äº LD å‚è€ƒçš„æ•°æ®é›†ä½ç½®
LD_REF <- 'D:/MR_Data/LD_Ref/1kg.v3'  # ä¸‹è½½ http://fileserve.mrcieu.ac.uk/ld/1kg.v3.tgz æ–‡ä»¶ï¼Œè§£å‹å½’æ¡£ã€‚ä¿è¯è¯¥ç›®å½•ä¸‹æœ‰å¯ç”¨çš„ .bedã€.bim å’Œ .fam æ–‡ä»¶
# ---åˆ†æç»“æœçš„æ ¹ç›®å½•ã€‚å¿…é¡»é¢„å…ˆæ‰‹åŠ¨åˆ›å»º
root_dir <- 'D:/MR_Data/MendelRookie_output'
# å­æ–‡ä»¶å¤¹å
topic <- paste0(EXPOSURE_NAME, '(', EXPOSURE_DATA_ID, ')', 'â†’', OUTCOME_NAME, '(', OUTCOME_DATA_ID, ')')
fmt <- '#_FORMATED_DATA'                   # æ•°æ®æ ¼å¼åŒ–
cor <- '1_correlation_analysis'            # ç›¸å…³æ€§åˆ†æ
ld <- '2_linkage_disequilibrium_analysis'  # è¿é”ä¸å¹³è¡¡åˆ†æ
mr_weak <- '3_remove_weak_IV'              # å¼±å·¥å…·å˜é‡å‰”é™¤
mr_con <- '4_remove_confounder'            # æ··æ‚å› ç´ å‰”é™¤
mr <- '5_do_MR'                            # å­Ÿå¾·å°”éšæœºåŒ–åˆ†æ
# å­æ–‡ä»¶å¤¹è·¯å¾„
FMT_DIR <- file.path(root_dir, fmt)
TOPIC_DIR <- file.path(root_dir, topic)
COR_DIR <- file.path(root_dir, topic, cor)
LD_DIR <- file.path(root_dir, topic, ld)
MR_WEAK_DIR <- file.path(root_dir, topic, mr_weak)
MR_CON_DIR <- file.path(root_dir, topic, mr_con)
MR_DIR <- file.path(root_dir, topic, mr)
dirs <- list(FMT_DIR, TOPIC_DIR, COR_DIR, LD_DIR, MR_WEAK_DIR, MR_CON_DIR, MR_DIR)
# æ–‡ä»¶ç›®å½•ä¸ #confounder_SNPs.txt æ–‡ä»¶åˆå§‹åŒ–
for (dir in dirs) { if (!dir.exists(dir)) { dir.create(dir) } }
confounder_file <- file.path(MR_CON_DIR, '#confounder_SNPs.txt')
if (!file.exists(confounder_file)) { file.create(confounder_file) }
# ç§»é™¤æ— ç”¨çš„å˜é‡
GLOBAL_VAR <- c('EXPOSURE_NAME', 'OUTCOME_NAME',  # æš´éœ²å› ç´ å’Œç»“å±€çš„ç®€ç§°
'EXPOSURE_DATA_ID', 'OUTCOME_DATA_ID',  # GWAS æ•°æ®æ ‡è¯†ç¬¦
'EXPOSURE_REFER_ID', 'OUTCOME_REFER_ID',  # å‚è€ƒåŸºå› ç»„æ ‡è¯†ç¬¦
'EXPOSURE_POP', 'OUTCOME_POP',  # äººç¾¤ç±»åˆ«
'LD_REF',  # ç”¨äº LD å‚è€ƒçš„æ•°æ®é›†ä½ç½®
'FMT_DIR', 'COR_DIR', 'LD_DIR', 'MR_WEAK_DIR', 'MR_CON_DIR', 'MR_DIR',  # å­æ–‡ä»¶å¤¹è·¯å¾„
'GLOBAL_VAR')
setwd(FMT_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
exposure_file <- "D:/MR_Data/GWAS_Data/GCST90014006/harmonised/harmonised.qc.tsv"  # GWASæ•°æ®ï¼Œç”¨ä½œæš´éœ²å› ç´ 
outcome_file <- "D:/MR_Data/GWAS_Data/GCST90275127/harmonised/GCST90275127.h.tsv"   # GWASæ•°æ®ï¼Œç”¨ä½œç»“å±€
setwd(COR_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
exposure_csv_file <- file.path(FMT_DIR, paste0(EXPOSURE_NAME, "_", EXPOSURE_DATA_ID, "_formatted.csv.gz"))
P_THRESHOLD <- 5e-05  # SNPs ç­›é€‰çš„é˜ˆå€¼ï¼ˆå»ºè®®å€¼ï¼š5e-8ï¼‰
# ---è¯»å–æ•°æ®å®Œæˆäº†æ ¼å¼åŒ–çš„æ•°æ®
exposure_data <- TwoSampleMR::read_exposure_data(  # æ³¨æ„åˆ—åï¼
filename = exposure_csv_file, sep = ',',
snp_col = 'SNP', chr_col = 'CHR', pos_col = 'BP',
effect_allele_col = 'A1', other_allele_col = 'A2',
beta_col = 'BETA', se_col = 'SE', eaf_col = 'FRQ', pval_col = 'P',
samplesize_col = 'N',
)
# ---å¿…è¦æ—¶è¡¥é½ samplesize.exposure åˆ—
if (all(is.na(exposure_data$samplesize.exposure))) {
while (TRUE) {
num <- readline(prompt = "samplesize.exposure åˆ—ç¼ºå¤±ï¼Œè¯·æ ¹æ®æ•°æ®æ¥æºï¼ˆç½‘é¡µã€MataInfoã€æ–‡çŒ®ç­‰ï¼‰å°†è¯¥åˆ—å¡«å……ä¸ºç»Ÿä¸€æ•°å€¼ï¼š")
if (grepl("^\\d+\\.?\\d*$", num)) {
exposure_data$samplesize.exposure <- as.numeric(num)
message("å·²å°† ", num, " å¡«å……è‡³ samplesize.exposure åˆ—")
break
} else { stop("è¾“å…¥æœ‰è¯¯ï¼åªæ”¯æŒæ•°å€¼å‹") }
}
}
# ---å¿…è¦æ—¶è¡¥é½ samplesize.exposure åˆ—
if (all(is.na(exposure_data$samplesize.exposure))) {
while (TRUE) {
num <- readline(prompt = "samplesize.exposure åˆ—ç¼ºå¤±ï¼Œè¯·æ ¹æ®æ•°æ®æ¥æºï¼ˆç½‘é¡µã€MataInfoã€æ–‡çŒ®ç­‰ï¼‰å°†è¯¥åˆ—å¡«å……ä¸ºç»Ÿä¸€æ•°å€¼ï¼š")
if (grepl("^\\d+\\.?\\d*$", num)) {
exposure_data$samplesize.exposure <- as.numeric(num)
message("å·²å°† ", num, " å¡«å……è‡³ samplesize.exposure åˆ—")
break
} else { stop("è¾“å…¥æœ‰è¯¯ï¼åªæ”¯æŒæ•°å€¼å‹") }
}
}
# ---å¿…è¦æ—¶è¡¥é½ samplesize.exposure åˆ—
if (all(is.na(exposure_data$samplesize.exposure))) {
while (TRUE) {
num <- readline(prompt = "samplesize.exposure åˆ—ç¼ºå¤±ï¼Œè¯·æ ¹æ®æ•°æ®æ¥æºï¼ˆç½‘é¡µã€MataInfoã€æ–‡çŒ®ç­‰ï¼‰å°†è¯¥åˆ—å¡«å……ä¸ºç»Ÿä¸€æ•°å€¼ï¼š")
if (grepl("^\\d+\\.?\\d*$", num)) {
exposure_data$samplesize.exposure <- as.numeric(num)
message("å·²å°† ", num, " å¡«å……è‡³ samplesize.exposure åˆ—")
break
} else { stop("è¾“å…¥æœ‰è¯¯ï¼åªæ”¯æŒæ•°å€¼å‹") }
}
}
# ---æ»¤å»å…³è”æ€§å¼±çš„ SNP å¹¶è¾“å‡ºåˆ°æ–‡ä»¶
output_data <- subset(exposure_data, pval.exposure < P_THRESHOLD)
cat(paste("å‰©ä½™", nrow(output_data), "ä¸ª SNP"))
write.csv(output_data, file = 'exposure.pvalue.csv', row.names = FALSE); file.create(paste0("exposure.pvalue.csv - Pï¼œ", P_THRESHOLD))
# ---ç»˜åˆ¶æ›¼å“ˆé¡¿å›¾ï¼šå‡†å¤‡æ•°æ®å¹¶ç»˜å›¾è¾“å‡º
exposure_data <- exposure_data[, c("SNP", "chr.exposure", "pos.exposure", "pval.exposure")]
colnames(exposure_data) <- c("SNP", "CHR", "BP", "pvalue")
CMplot(exposure_data,
plot.type = "m",  # mï¼šçº¿æ€§æ›¼å“ˆé¡¿å›¾
LOG10 = TRUE, threshold = P_THRESHOLD, threshold.lwd = 3, threshold.lty = 1, signal.cex = 0.2,
chr.den.col = NULL, cex = 0.2, bin.size = 1e5, ylim = c(0, 50), width = 15, height = 9,
file.output = TRUE, file = output_fmt, verbose = TRUE
)
output_fmt
setwd(COR_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
exposure_csv_file <- file.path(FMT_DIR, paste0(EXPOSURE_NAME, "_", EXPOSURE_DATA_ID, "_formatted.csv.gz"))
P_THRESHOLD <- 5e-05  # SNPs ç­›é€‰çš„é˜ˆå€¼ï¼ˆå»ºè®®å€¼ï¼š5e-8ï¼‰
output_fmt <- "png"   # æ”¯æŒçš„æ ¼å¼ï¼šjpgã€pdfã€tiffã€png
CMplot(exposure_data,
plot.type = "m",  # mï¼šçº¿æ€§æ›¼å“ˆé¡¿å›¾
LOG10 = TRUE, threshold = P_THRESHOLD, threshold.lwd = 3, threshold.lty = 1, signal.cex = 0.2,
chr.den.col = NULL, cex = 0.2, bin.size = 1e5, ylim = c(0, 50), width = 15, height = 9,
file.output = TRUE, file = output_fmt, verbose = TRUE
)
setwd(LD_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
exposure_csv_file <- file.path(COR_DIR, "exposure.pvalue.csv")
CLUMP_KB <- 500  # è¿é”äº’æ¢çš„è·ç¦»ï¼ˆå»ºè®®å€¼ï¼š10000ï¼‰
CLUMP_R2 <- 0.1  # è¿é”äº’æ¢çš„ RÂ² é˜ˆå€¼ï¼ˆå»ºè®®å€¼ï¼š0.001ï¼‰
# ---è¯»å–æš´éœ²æ•°æ®
exposure_data <- read.csv(exposure_csv_file, header = TRUE, sep = ",", check.names = FALSE)
# ---å»é™¤è¿é”ä¸å¹³è¡¡çš„ SNP å¹¶ä¿å­˜
unclump_snps <- ieugwasr::ld_clump(dat = dplyr::tibble(rsid = exposure_data$SNP, pval = exposure_data$pval.exposure, id = exposure_data$id.exposure),
clump_kb = CLUMP_KB,
clump_r2 = CLUMP_R2,
plink_bin = get_plink_exe(),
bfile = file.path(LD_REF, EXPOSURE_POP))
exposure_data <- exposure_data %>%
dplyr::inner_join(unclump_snps, by = c("SNP" = "rsid")) %>%
dplyr::select(names(.))
print(paste("å‰©ä½™", nrow(exposure_data), "ä¸ª SNP"))
write.csv(exposure_data, file = "exposure.LD.csv", row.names = FALSE); file.create(paste0("exposure.LD.csv - ", CLUMP_KB, " kb, ", CLUMP_R2, "RÂ²"))
rm(list = setdiff(ls(), GLOBAL_VAR))  # ç§»é™¤æ— ç”¨çš„å˜é‡
gc()
exposure_data
setwd(MR_WEAK_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
exposure_csv_file <- file.path(LD_DIR, "exposure.LD.csv")
exposure_csv_file
F_THRESHOLD <- 10  # F ç»Ÿè®¡é‡é˜ˆå€¼
# ---è¯»å–è¿é”ä¸å¹³è¡¡åˆ†æç»“æœæ–‡ä»¶
exposure_data <- read.csv(exposure_csv_file, header = TRUE, sep = ",", check.names = FALSE)
# ---è¡¥é½ RÂ² å’Œ F åˆ—
exposure_data$R2 <- TwoSampleMR::get_r_from_bsen(exposure_data$beta.exposure, exposure_data$se.exposure, exposure_data$samplesize.exposure)^2
exposure_data$Fval <- (exposure_data$samplesize.exposure - 2) * exposure_data$R2 / (1 - exposure_data$R2)
# ---è¿‡æ»¤ä¿ç•™ F>10 çš„å·¥å…·å˜é‡
exposure_data <- exposure_data[exposure_data$F > F_THRESHOLD,]
print(paste("å‰©ä½™", nrow(exposure_data), "ä¸ª SNP"))
write.csv(exposure_data, "exposure.F.csv", row.names = FALSE); file.create(paste0("exposure.F.csv - Fï¼", F_THRESHOLD))
rm(list = setdiff(ls(), GLOBAL_VAR))  # ç§»é™¤æ— ç”¨çš„å˜é‡
setwd(MR_CON_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
exposure_csv_file <- file.path(MR_WEAK_DIR, "exposure.F.csv")
# ---è¯»å–å»é™¤äº†å¼±å·¥å…·å˜é‡çš„ç»“æœæ–‡ä»¶
exposure_data <- read.csv(exposure_csv_file, header = TRUE, sep = ",", check.names = FALSE)
# è·å–å½“å‰çš„å·¥å…·å˜é‡è¡¨å‹å¹¶ä¿å­˜åˆ°æ–‡ä»¶
snp_with_trait <- FastTraitR::look_trait(rsids = exposure_data$SNP, out_file = 'check_SNPs_trait.csv')
snp_with_trait_save <- snp_with_trait %>%
arrange(trait) %>%
select(trait) %>%
distinct()  # å·¥å…·å˜é‡è¡¨å‹å»é‡
writeLines(snp_with_trait_save$trait, 'check_SNPs_trait.txt')  # ä¿å­˜åˆ°æ–‡ä»¶
print(paste("å½“å‰ç­›é€‰åˆ°çš„ SNPs è¡¨å‹æè¿°ï¼ŒæŒ‰è¡Œåˆ†éš”åœ°ä¿å­˜åˆ°äº† check_SNPs_trait.txt æ–‡ä»¶ï½"))
# ----ğŸ‘‡æ‰‹åŠ¨æ•´ç†æ··æ‚å› ç´ åˆ—è¡¨----
message(paste0("æŸ¥çœ‹ check_SNPs_trait.txt æ–‡ä»¶ä¸­çš„è¡¨å‹æ˜¯å¦ä¸º [", EXPOSURE_NAME, " â†’ ", OUTCOME_NAME, "] çš„æ··æ‚å› ç´ ï¼Œ\nå°†æ··æ‚å› ç´ ä¿å­˜åˆ° ./4_remove_confounder/#confounder_SNPs.txt æ–‡ä»¶ï¼"))
if (file.info("#confounder_SNPs.txt")$size == 0) { stop("è¯·æ‰‹åŠ¨æ•´ç†æ··æ‚å› ç´ åˆ—è¡¨æ–‡ä»¶ #confounder_SNPs.txtï¼") }
# ----ğŸ‘‡æ‰‹åŠ¨æ•´ç†æ··æ‚å› ç´ åˆ—è¡¨----
message(paste0("æŸ¥çœ‹ check_SNPs_trait.txt æ–‡ä»¶ä¸­çš„è¡¨å‹æ˜¯å¦ä¸º [", EXPOSURE_NAME, " â†’ ", OUTCOME_NAME, "] çš„æ··æ‚å› ç´ ï¼Œ\nå°†æ··æ‚å› ç´ ä¿å­˜åˆ° ./4_remove_confounder/#confounder_SNPs.txt æ–‡ä»¶ï¼"))
if (file.info("#confounder_SNPs.txt")$size == 0) { stop("è¯·æ‰‹åŠ¨æ•´ç†æ··æ‚å› ç´ åˆ—è¡¨æ–‡ä»¶ #confounder_SNPs.txtï¼") }
# ---æ¯”è¾ƒå¹¶å‰”é™¤åŒ…å«åœ¨æ–‡æœ¬æ–‡ä»¶ä¸­çš„çŸ­è¯­çš„ SNPï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶
confounders <- readLines("#confounder_SNPs.txt")
snp_with_trait$trait <- tolower(snp_with_trait$trait)  # ç¡®ä¿ trait åˆ—æ–‡æœ¬å‡ä¸ºå°å†™
for (confounder in confounders) {
snp_with_trait <- snp_with_trait[!grepl(tolower(confounder), snp_with_trait$trait),]
}
snp_with_trait <- dplyr::distinct(snp_with_trait, rsid, .keep_all = FALSE)  # å»é‡
exposure_data <- exposure_data %>%
dplyr::inner_join(snp_with_trait, by = c("SNP" = "rsid")) %>%
dplyr::select(names(exposure_data))
print(paste("å‰”é™¤æ··æ‚å› ç´ åï¼Œå‰©ä½™", nrow(exposure_data), "ä¸ª SNP"))
print(paste("å‰©ä½™", nrow(exposure_data), "ä¸ª SNP"))
write.csv(exposure_data, "exposure.confounder.csv", row.names = FALSE)
setwd(MR_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
exposure_csv_file <- file.path(MR_CON_DIR, "exposure.confounder.csv")
outcome_file <- file.path(FMT_DIR, paste0(OUTCOME_NAME, "_", OUTCOME_DATA_ID, "_formatted.csv.gz"))
# ---è¯»å–æ•´ç†å¥½çš„æš´éœ²æ•°æ®
exposure_data <- read.csv(exposure_csv_file, header = TRUE, sep = ",", check.names = FALSE)
# ---è¯»å–ç»“å±€æ•°æ®
outcome_data <- TwoSampleMR::read_outcome_data(  # æ³¨æ„åˆ—åï¼
filename = outcome_file, sep = ',',
snp_col = 'SNP',
effect_allele_col = 'A1', other_allele_col = 'A2',
beta_col = 'BETA', se_col = 'SE', eaf_col = 'FRQ', pval_col = 'P'
)
# ---ç­›é€‰ç»“å±€æ•°æ®ä¸­ï¼Œä¸å·¥å…·å˜é‡ç›¸äº¤é›†çš„éƒ¨åˆ†ï¼Œå¹¶è¾“å‡ºåˆ°æ–‡ä»¶
outcome_table <- merge(exposure_data, outcome_data, by.x = "SNP", by.y = "SNP")
write.csv(outcome_table[, -(2:ncol(exposure_data))], file = "outcome.csv")
rm(outcome_table)
# ---å°†æš´éœ²æ•°æ®å’Œç»“å±€æ•°æ®æ‰“æ ‡ç­¾åæ•´åˆåˆ°ä¸€ä¸ªæ•°æ®æ¡†
exposure_data$exposure <- EXPOSURE_NAME
outcome_data$outcome <- OUTCOME_NAME
data <- TwoSampleMR::harmonise_data(exposure_data, outcome_data, action = 1)
# ---è¾“å‡ºå·¥å…·å˜é‡
write.csv(data[data$mr_keep == "TRUE",], file = "SNP.csv", row.names = FALSE)
# ---MR-PRESSO æ–¹æ³•è¿›è¡Œå¼‚å¸¸å€¼æ£€æµ‹ï¼Œå¾—åˆ°åå€šçš„ SNP
mr_presso_result <- run_mr_presso(data)
write.csv(mr_presso_result[[1]]$
`MR-PRESSO results`$
`Outlier Test`, file = "outlier_SNPs.csv")
# ---æ‰§è¡Œå­Ÿå¾·å°”éšæœºåŒ–åˆ†æ
mr_result <- mr(data)
write.csv(generate_odds_ratios(mr_result), file = "MR-Result.csv", row.names = FALSE)
# ---å¼‚è´¨æ€§æ£€éªŒ
write.csv(mr_heterogeneity(data), file = "heterogeneity.csv", row.names = FALSE)
# ---å¤šæ•ˆæ€§æ£€éªŒ
write.csv(mr_pleiotropy_test(data), file = "pleiotropy.csv", row.names = FALSE)
# ---ç»˜å›¾
pdf(file = "pic.scatter_plot.pdf", width = 7.5, height = 7); mr_scatter_plot(mr_result, data); dev.off()  # æ•£ç‚¹å›¾
res_single <- mr_singlesnp(data)
pdf(file = "pic.forest.pdf", width = 7, height = 6.5); mr_forest_plot(res_single); dev.off()  # æ£®æ—å›¾
pdf(file = "pic.funnel_plot.pdf", width = 7, height = 6.5); mr_funnel_plot(singlesnp_results = res_single); dev.off()  # æ¼æ–—å›¾
pdf(file = "pic.leaveoneout.pdf", width = 7, height = 6.5); mr_leaveoneout_plot(leaveoneout_results = mr_leaveoneout(data)); dev.off()  # æ•æ„Ÿæ€§åˆ†æ
rm(list = setdiff(ls(), GLOBAL_VAR))  # ç§»é™¤æ— ç”¨çš„å˜é‡
gc()  # åƒåœ¾å›æ”¶
setwd(MR_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
result_file <- file.path(MR_DIR, "MR-Result.csv")
pFilter <- 1  # æ˜¯å¦æ ¹æ® P å€¼è¿‡æ»¤ï¼Ÿ1ï¼šä¸è¿‡æ»¤ï¼›0.05ï¼šè¿‡æ»¤
draw_forest_map <- function(inputFile = null, forestFile = null, forestCol = null) {
# è¯»å–è¾“å…¥æ–‡ä»¶
rt <- read.csv(inputFile, header = T, sep = ",", check.names = F)
row.names(rt) <- rt$method
rt <- rt[rt$pval < pFilter,]
method <- rownames(rt)
or <- sprintf("%.3f", rt$"or")
orLow <- sprintf("%.3f", rt$"or_lci95")
orHigh <- sprintf("%.3f", rt$"or_uci95")
OR <- paste0(or, "(", orLow, "-", orHigh, ")")
pVal <- ifelse(rt$pval < 0.001, "<0.001", sprintf("%.3f", rt$pval))
#è¾“å‡ºå›¾å½¢
pdf(file = forestFile, width = 7, height = 4.6)
n <- nrow(rt)
nRow <- n + 1
ylim <- c(1, nRow)
layout(matrix(c(1, 2), nc = 2), width = c(3.5, 2))
# å·¦ä¾§
xlim <- c(0, 3)
par(mar = c(4, 2.5, 2, 1))
plot(1, xlim = xlim, ylim = ylim, type = "n", axes = F, xlab = "", ylab = "")
text.cex <- 0.8
text(0, n:1, method, adj = 0, cex = text.cex)
text(1.9, n:1, pVal, adj = 1, cex = text.cex); text(1.9, n + 1, 'pvalue', cex = 1, font = 2, adj = 1)
text(3.1, n:1, OR, adj = 1, cex = text.cex); text(2.7, n + 1, 'OR', cex = 1, font = 2, adj = 1)
# å³ä¾§
par(mar = c(4, 1, 2, 1), mgp = c(2, 0.5, 0))
xlim <- c(min(as.numeric(orLow) * 0.975, as.numeric(orHigh) * 0.975, 0.9), max(as.numeric(orLow), as.numeric(orHigh)) * 1.025)
plot(1, xlim = xlim, ylim = ylim, type = "n", axes = F, ylab = "", xaxs = "i", xlab = "OR")
arrows(as.numeric(orLow), n:1, as.numeric(orHigh), n:1, angle = 90, code = 3, length = 0.05, col = "darkblue", lwd = 3)
abline(v = 1, col = "black", lty = 2, lwd = 2)
boxcolor <- ifelse(as.numeric(or) > 1, forestCol, forestCol)
points(as.numeric(or), n:1, pch = 15, col = boxcolor, cex = 2)
axis(1)
dev.off()
}
draw_forest_map(inputFile = result_file, forestFile = "forest_map.pdf", forestCol = "red")
rm(list = setdiff(ls(), GLOBAL_VAR))  # ç§»é™¤æ— ç”¨çš„å˜é‡
setwd(MR_DIR); cat("å½“å‰å·¥ä½œç›®å½•ï¼š", getwd())
result_file <- file.path(MR_DIR, "MR-Result.csv")
pFilter <- 1  # æ˜¯å¦æ ¹æ® P å€¼è¿‡æ»¤ï¼Ÿ1ï¼šä¸è¿‡æ»¤ï¼›0.05ï¼šè¿‡æ»¤
draw_forest_map <- function(inputFile = null, forestFile = null, forestCol = null) {
# è¯»å–è¾“å…¥æ–‡ä»¶
rt <- read.csv(inputFile, header = T, sep = ",", check.names = F)
row.names(rt) <- rt$method
rt <- rt[rt$pval < pFilter,]
method <- rownames(rt)
or <- sprintf("%.3f", rt$"or")
orLow <- sprintf("%.3f", rt$"or_lci95")
orHigh <- sprintf("%.3f", rt$"or_uci95")
OR <- paste0(or, "(", orLow, "-", orHigh, ")")
pVal <- ifelse(rt$pval < 0.001, "<0.001", sprintf("%.3f", rt$pval))
#è¾“å‡ºå›¾å½¢
pdf(file = forestFile, width = 7, height = 4.6)
n <- nrow(rt)
nRow <- n + 1
ylim <- c(1, nRow)
layout(matrix(c(1, 2), nc = 2), width = c(3.5, 2))
# å·¦ä¾§
xlim <- c(0, 3)
par(mar = c(4, 2.5, 2, 1))
plot(1, xlim = xlim, ylim = ylim, type = "n", axes = F, xlab = "", ylab = "")
text.cex <- 0.8
text(0, n:1, method, adj = 0, cex = text.cex)
text(1.9, n:1, pVal, adj = 1, cex = text.cex); text(1.9, n + 1, 'pvalue', cex = 1, font = 2, adj = 1)
text(3.1, n:1, OR, adj = 1, cex = text.cex); text(2.7, n + 1, 'OR', cex = 1, font = 2, adj = 1)
# å³ä¾§
par(mar = c(4, 1, 2, 1), mgp = c(2, 0.5, 0))
xlim <- c(min(as.numeric(orLow) * 0.975, as.numeric(orHigh) * 0.975, 0.9), max(as.numeric(orLow), as.numeric(orHigh)) * 1.025)
plot(1, xlim = xlim, ylim = ylim, type = "n", axes = F, ylab = "", xaxs = "i", xlab = "OR")
arrows(as.numeric(orLow), n:1, as.numeric(orHigh), n:1, angle = 90, code = 3, length = 0.05, col = "darkblue", lwd = 3)
abline(v = 1, col = "black", lty = 2, lwd = 2)
boxcolor <- ifelse(as.numeric(or) > 1, forestCol, forestCol)
points(as.numeric(or), n:1, pch = 15, col = boxcolor, cex = 2)
axis(1)
dev.off()
}
draw_forest_map(inputFile = result_file, forestFile = "forest_map.pdf", forestCol = "red")
rm(list = setdiff(ls(), GLOBAL_VAR))  # ç§»é™¤æ— ç”¨çš„å˜é‡
